"use strict";
var __extends = (this && this.__extends) || (function () {
    var extendStatics = Object.setPrototypeOf ||
        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
        function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };
    return function (d, b) {
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __assign = (this && this.__assign) || Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
        s = arguments[i];
        for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
            t[p] = s[p];
    }
    return t;
};
Object.defineProperty(exports, "__esModule", { value: true });
var vuex_1 = require("vuex");
var useRootNamespace = { root: true };
var ModuleBuilderImpl = /** @class */ (function () {
    function ModuleBuilderImpl(namespace, _initialState) {
        this.namespace = namespace;
        this._initialState = _initialState;
        this._getters = {};
        this._mutations = {};
        this._actions = {};
        this._moduleBuilders = {};
    }
    ModuleBuilderImpl.prototype.state = function () {
        var _this = this;
        if (!this.namespace) {
            return function () { return _this._store.state; };
        }
        else if (this.namespace.indexOf('/') < 0) {
            return function () { return _this._store.state[_this.namespace]; };
        }
        else {
            var namespaces_1 = this.namespace.split('/');
            return function () {
                var accessor = _this._store.state;
                for (var _i = 0, namespaces_2 = namespaces_1; _i < namespaces_2.length; _i++) {
                    var name_1 = namespaces_2[_i];
                    accessor = accessor[name_1];
                }
                return accessor;
            };
        }
    };
    ModuleBuilderImpl.prototype.module = function (namespace, initialState) {
        var existingModule = this._moduleBuilders[namespace];
        var qualifiedNamespace = qualifyNamespace(this.namespace, namespace);
        if (!initialState) {
            // no second argument: get an existing module
            if (!existingModule) {
                throw new Error("There is no module named '" + qualifiedNamespace + "'.  If you meant to create a nested module, then provide initial-state as the second argument.'");
            }
            return existingModule;
        }
        // both arguments: create a module
        if (existingModule) {
            throw new Error("There is already a module named '" + qualifiedNamespace + "'.  If you meant to get the existing module, then provide no initialState argument.");
        }
        var nestedBuilder = new ModuleBuilderImpl(qualifiedNamespace, initialState);
        this._moduleBuilders[namespace] = nestedBuilder;
        return nestedBuilder;
    };
    ModuleBuilderImpl.prototype.commit = function (handler, name) {
        var _this = this;
        var _a = qualifyKey(handler, this.namespace, name), key = _a.key, namespacedKey = _a.namespacedKey;
        if (this._mutations[key]) {
            throw new Error("There is already a mutation named " + key + ".");
        }
        this._mutations[key] = handler;
        return (function (payload) {
            return _this._store.commit(namespacedKey, payload, useRootNamespace);
        });
    };
    ModuleBuilderImpl.prototype.dispatch = function (handler, name) {
        var _this = this;
        var _a = qualifyKey(handler, this.namespace, name), key = _a.key, namespacedKey = _a.namespacedKey;
        if (this._actions[key]) {
            throw new Error("There is already an action named " + key + ".");
        }
        this._actions[key] = handler;
        return function (payload) {
            return _this._store.dispatch(namespacedKey, payload, useRootNamespace);
        };
    };
    ModuleBuilderImpl.prototype.read = function (handler, name) {
        var _this = this;
        var _a = qualifyKey(handler, this.namespace, name), key = _a.key, namespacedKey = _a.namespacedKey;
        if (this._getters[key]) {
            throw new Error("There is already a getter named " + key + ".");
        }
        this._getters[key] = handler;
        return function () {
            if (_this._store.rootGetters) {
                return _this._store.rootGetters[namespacedKey];
            }
            return _this._store.getters[namespacedKey];
        };
    };
    ModuleBuilderImpl.prototype.vuexModule = function () {
        if (!this._vuexModule) {
            // build nested modules recursively, if any
            var modules = {};
            for (var _i = 0, _a = Object.keys(this._moduleBuilders); _i < _a.length; _i++) {
                var namespace = _a[_i];
                modules[namespace] = this._moduleBuilders[namespace].vuexModule();
            }
            this._vuexModule = {
                namespaced: true,
                state: this._initialState,
                getters: this._getters,
                mutations: this._mutations,
                actions: this._actions,
                modules: modules
            };
        }
        return this._vuexModule;
    };
    ModuleBuilderImpl.prototype._provideStore = function (store) {
        this._store = store;
        forEachValue(this._moduleBuilders, function (m) { return m._provideStore(store); });
    };
    return ModuleBuilderImpl;
}());
function qualifyKey(handler, namespace, name) {
    var key = name || handler.name;
    if (!key) {
        throw new Error("Vuex handler functions must not be anonymous. Possible causes: fat-arrow functions, uglify.  To fix, pass a unique name as a second parameter after your callback.");
    }
    return { key: key, namespacedKey: qualifyNamespace(namespace, key) };
}
function qualifyNamespace(namespace, key) {
    return namespace ? namespace + "/" + key : key;
}
var StoreBuilderImpl = /** @class */ (function (_super) {
    __extends(StoreBuilderImpl, _super);
    function StoreBuilderImpl() {
        return _super.call(this, '', {}) || this;
    }
    StoreBuilderImpl.prototype.module = function (namespace, initialState) {
        if (this._store && initialState) {
            throw new Error("Can't add module after vuexStore() has been called");
        }
        return _super.prototype.module.call(this, namespace, initialState);
    };
    StoreBuilderImpl.prototype.vuexStore = function (overrideOptions) {
        if (overrideOptions === void 0) { overrideOptions = {}; }
        if (!this._store) {
            var options = __assign({}, this.vuexModule(), overrideOptions);
            var store_1 = new vuex_1.Store(options);
            forEachValue(this._moduleBuilders, function (m) { return m._provideStore(store_1); });
            this._store = store_1;
        }
        return this._store;
    };
    StoreBuilderImpl.prototype.reset = function () {
        this._store = undefined;
        this._moduleBuilders = {};
    };
    return StoreBuilderImpl;
}(ModuleBuilderImpl));
var forEachValue = function (dict, loop) {
    Object.keys(dict).forEach(function (key) { return loop(dict[key]); });
};
var storeBuilderSingleton = new StoreBuilderImpl();
var namedStoreBuilderMap = Object.create(null);
function getStoreBuilder(name) {
    // the default store builder
    if (!name) {
        return storeBuilderSingleton;
    }
    // a named store builder
    var builder = namedStoreBuilderMap[name] ||
        (namedStoreBuilderMap[name] = new StoreBuilderImpl());
    return builder;
}
exports.getStoreBuilder = getStoreBuilder;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidnVlLXR5cGV4LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsidnVlLXR5cGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsNkJBVWM7QUFFZCxJQUFNLGdCQUFnQixHQUFHLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxDQUFDO0FBcUJ4QztJQVVFLDJCQUE0QixTQUFpQixFQUFVLGFBQWdCO1FBQTNDLGNBQVMsR0FBVCxTQUFTLENBQVE7UUFBVSxrQkFBYSxHQUFiLGFBQWEsQ0FBRztRQVA3RCxhQUFRLEdBQXFCLEVBQUUsQ0FBQztRQUNoQyxlQUFVLEdBQW9CLEVBQUUsQ0FBQztRQUNqQyxhQUFRLEdBQXFCLEVBQUUsQ0FBQztRQUNoQyxvQkFBZSxHQUFzQyxFQUFFLENBQUM7SUFJUSxDQUFDO0lBRTNFLGlDQUFLLEdBQUw7UUFBQSxpQkFlQztRQWRDLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFO1lBQ25CLE9BQU8sY0FBTSxPQUFNLEtBQUksQ0FBQyxNQUFPLENBQUMsS0FBVyxFQUE5QixDQUE4QixDQUFDO1NBQzdDO2FBQU0sSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDMUMsT0FBTyxjQUFNLE9BQU0sS0FBSSxDQUFDLE1BQU8sQ0FBQyxLQUFNLENBQUMsS0FBSSxDQUFDLFNBQVMsQ0FBTSxFQUE5QyxDQUE4QyxDQUFDO1NBQzdEO2FBQU07WUFDTCxJQUFNLFlBQVUsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUM3QyxPQUFPO2dCQUNMLElBQUksUUFBUSxHQUFRLEtBQUksQ0FBQyxNQUFPLENBQUMsS0FBSyxDQUFDO2dCQUN2QyxLQUFtQixVQUFVLEVBQVYsZUFBQSxZQUFVLEVBQVYsd0JBQVUsRUFBVixJQUFVO29CQUF4QixJQUFNLE1BQUksbUJBQUE7b0JBQ2IsUUFB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LENBQUMsTUFBTSxDQUFDO0lBQ3JCLENBQUM7SUFFRCxnQ0FBSyxHQUFMO1FBQ0UsSUFBSSxDQUFDLE1BQU0sR0FBRyxTQUFTLENBQUM7UUFDeEIsSUFBSSxDQUFDLGVBQWUsR0FBRyxFQUFFLENBQUM7SUFDNUIsQ0FBQztJQUNILHVCQUFDO0FBQUQsQ0FBQyxBQWxDRCxDQUFrQyxpQkFBaUIsR0FrQ2xEO0FBRUQsSUFBTSxZQUFZLEdBQUcsVUFBSSxJQUFtQixFQUFFLElBQXVCO0lBQ25FLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLFVBQUEsR0FBRyxJQUFJLE9BQUEsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFmLENBQWUsQ0FBQyxDQUFDO0FBQ3BELENBQUMsQ0FBQztBQThERixJQUFNLHFCQUFxQixHQUFHLElBQUksZ0JBQWdCLEVBQU8sQ0FBQztBQUMxRCxJQUFNLG9CQUFvQixHQUV0QixNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO0FBTXhCLHlCQUFtQyxJQUFhO0lBQzlDLDRCQUE0QjtJQUM1QixJQUFJLENBQUMsSUFBSSxFQUFFO1FBQ1QsT0FBTyxxQkFBcUIsQ0FBQztLQUM5QjtJQUVELHdCQUF3QjtJQUN4QixJQUFNLE9BQU8sR0FDWCxvQkFBb0IsQ0FBQyxJQUFJLENBQUM7UUFDMUIsQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLGdCQUFnQixFQUFLLENBQUMsQ0FBQztJQUMzRCxPQUFPLE9BQU8sQ0FBQztBQUNqQixDQUFDO0FBWEQsMENBV0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBBY3Rpb25Db250ZXh0LFxuICBBY3Rpb25UcmVlLFxuICBHZXR0ZXJUcmVlLFxuICBNb2R1bGUsXG4gIE11dGF0aW9uVHJlZSxcbiAgU3RvcmUsXG4gIFN0b3JlT3B0aW9ucyxcbiAgTW9kdWxlVHJlZSxcbiAgUGx1Z2luXG59IGZyb20gJ3Z1ZXgnO1xuXG5jb25zdCB1c2VSb290TmFtZXNwYWNlID0geyByb290OiB0cnVlIH07XG5cbmV4cG9ydCB0eXBlIE11dGF0aW9uSGFuZGxlcjxTLCBQPiA9IChzdGF0ZTogUywgcGF5bG9hZDogUCkgPT4gdm9pZDtcbmV4cG9ydCB0eXBlIEFjdGlvbkhhbmRsZXI8UywgUiwgUCwgVD4gPSAoXG4gIGNvbnRleHQ6IEJhcmVBY3Rpb25Db250ZXh0PFMsIFI+LFxuICBwYXlsb2FkOiBQXG4pID0+IFByb21pc2U8VD4gfCBUO1xuZXhwb3J0IHR5cGUgR2V0dGVySGFuZGxlcjxTLCBSLCBUPiA9IChzdGF0ZTogUywgcm9vdFN0YXRlOiBSKSA9PiBUO1xuXG5pbnRlcmZhY2UgRGljdGlvbmFyeTxUPiB7XG4gIFtrZXk6IHN0cmluZ106IFQ7XG59XG5pbnRlcmZhY2UgUm9vdFN0b3JlPFI+IGV4dGVuZHMgU3RvcmU8Uj4ge1xuICByb290R2V0dGVycz86IGFueTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBCYXJlQWN0aW9uQ29udGV4dDxTLCBSPiB7XG4gIHN0YXRlOiBTO1xuICByb290U3RhdGU6IFI7XG59XG5cbmNsYXNzIE1vZHVsZUJ1aWxkZXJJbXBsPFMsIFIgPSB7fT4gaW1wbGVtZW50cyBNb2R1bGVCdWlsZGVyPFMsIFI+IHtcbiAgcHJvdGVjdGVkIF9zdG9yZTogUm9vdFN0b3JlPFI+IHwgdW5kZWZpbmVkO1xuXG4gIHByb3RlY3RlZCBfZ2V0dGVyczogR2V0dGVyVHJlZTxTLCBSPiA9IHt9O1xuICBwcm90ZWN0ZWQgX211dGF0aW9uczogTXV0YXRpb25UcmVlPFM+ID0ge307XG4gIHByb3RlY3RlZCBfYWN0aW9uczogQWN0aW9uVHJlZTxTLCBSPiA9IHt9O1xuICBwcm90ZWN0ZWQgX21vZHVsZUJ1aWxkZXJzOiBEaWN0aW9uYXJ5PE1vZHVsZUJ1aWxkZXI8YW55LCBSPj4gPSB7fTtcblxuICBwcm90ZWN0ZWQgX3Z1ZXhNb2R1bGU6IE1vZHVsZTxTLCBSPiB8IHVuZGVmaW5lZDtcblxuICBjb25zdHJ1Y3RvcihwdWJsaWMgcmVhZG9ubHkgbmFtZXNwYWNlOiBzdHJpbmcsIHByaXZhdGUgX2luaXRpYWxTdGF0ZTogUykge31cblxuICBzdGF0ZSgpOiAoKSA9PiBTIHtcbiAgICBpZiAoIXRoaXMubmFtZXNwYWNlKSB7XG4gICAgICByZXR1cm4gKCkgPT4gKDxhbnk+dGhpcy5fc3RvcmUhLnN0YXRlKSBhcyBTO1xuICAgIH0gZWxzZSBpZiAodGhpcy5uYW1lc3BhY2UuaW5kZXhPZignLycpIDwgMCkge1xuICAgICAgcmV0dXJuICgpID0+ICg8YW55PnRoaXMuX3N0b3JlIS5zdGF0ZSlbdGhpcy5uYW1lc3BhY2VdIGFzIFM7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IG5hbWVzcGFjZXMgPSB0aGlzLm5hbWVzcGFjZS5zcGxpdCgnLycpO1xuICAgICAgcmV0dXJuICgpID0+IHtcbiAgICAgICAgbGV0IGFjY2Vzc29yOiBhbnkgPSB0aGlzLl9zdG9yZSEuc3RhdGU7XG4gICAgICAgIGZvciAoY29uc3QgbmFtZSBvZiBuYW1lc3BhY2VzKSB7XG4gICAgICAgICAgYWNjZXNzb3IgPSBhY2Nlc3NvcltuYW1lXTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gKDxhbnk+YWNjZXNzb3IpIGFzIFM7XG4gICAgICB9O1xuICAgIH1cbiAgfVxuXG4gIG1vZHVsZTxNPihuYW1lc3BhY2U6IHN0cmluZywgaW5pdGlhbFN0YXRlOiBNKTogTW9kdWxlQnVpbGRlcjxNLCBSPjtcbiAgbW9kdWxlPE0+KG5hbWVzcGFjZTogc3RyaW5nKTogTW9kdWxlQnVpbGRlcjxNLCBSPjtcbiAgbW9kdWxlPE0+KG5hbWVzcGFjZTogc3RyaW5nLCBpbml0aWFsU3RhdGU/OiBNKTogTW9kdWxlQnVpbGRlcjxNLCBSPiB7XG4gICAgY29uc3QgZXhpc3RpbmdNb2R1bGUgPSB0aGlzLl9tb2R1bGVCdWlsZGVyc1tuYW1lc3BhY2VdO1xuICAgIGNvbnN0IHF1YWxpZmllZE5hbWVzcGFjZSA9IHF1YWxpZnlOYW1lc3BhY2UodGhpcy5uYW1lc3BhY2UsIG5hbWVzcGFjZSk7XG4gICAgaWYgKCFpbml0aWFsU3RhdGUpIHtcbiAgICAgIC8vIG5vIHNlY29uZCBhcmd1bWVudDogZ2V0IGFuIGV4aXN0aW5nIG1vZHVsZVxuICAgICAgaWYgKCFleGlzdGluZ01vZHVsZSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYFRoZXJlIGlzIG5vIG1vZHVsZSBuYW1lZCAnJHtxdWFsaWZpZWROYW1lc3BhY2V9Jy4gIElmIHlvdSBtZWFudCB0byBjcmVhdGUgYSBuZXN0ZWQgbW9kdWxlLCB0aGVuIHByb3ZpZGUgaW5pdGlhbC1zdGF0ZSBhcyB0aGUgc2Vjb25kIGFyZ3VtZW50LidgXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICByZXR1cm4gZXhpc3RpbmdNb2R1bGU7XG4gICAgfVxuXG4gICAgLy8gYm90aCBhcmd1bWVudHM6IGNyZWF0ZSBhIG1vZHVsZVxuICAgIGlmIChleGlzdGluZ01vZHVsZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgVGhlcmUgaXMgYWxyZWFkeSBhIG1vZHVsZSBuYW1lZCAnJHtxdWFsaWZpZWROYW1lc3BhY2V9Jy4gIElmIHlvdSBtZWFudCB0byBnZXQgdGhlIGV4aXN0aW5nIG1vZHVsZSwgdGhlbiBwcm92aWRlIG5vIGluaXRpYWxTdGF0ZSBhcmd1bWVudC5gXG4gICAgICApO1xuICAgIH1cbiAgICBjb25zdCBuZXN0ZWRCdWlsZGVyID0gbmV3IE1vZHVsZUJ1aWxkZXJJbXBsPE0sIFI+KFxuICAgICAgcXVhbGlmaWVkTmFtZXNwYWNlLFxuICAgICAgaW5pdGlhbFN0YXRlXG4gICAgKTtcbiAgICB0aGlzLl9tb2R1bGVCdWlsZGVyc1tuYW1lc3BhY2VdID0gbmVzdGVkQnVpbGRlcjtcbiAgICByZXR1cm4gbmVzdGVkQnVpbGRlcjtcbiAgfVxuXG4gIGNvbW1pdDxQPihoYW5kbGVyOiBNdXRhdGlvbkhhbmRsZXI8Uywgdm9pZD4pOiAoKSA9PiB2b2lkO1xuICBjb21taXQ8UD4oaGFuZGxlcjogTXV0YXRpb25IYW5kbGVyPFMsIFA+KTogKHBheWxvYWQ6IFApID0+IHZvaWQ7XG4gIGNvbW1pdDxQPihoYW5kbGVyOiBNdXRhdGlvbkhhbmRsZXI8Uywgdm9pZD4sIG5hbWU6IHN0cmluZyk6ICgpID0+IHZvaWQ7XG4gIGNvbW1pdDxQPihoYW5kbGVyOiBNdXRhdGlvbkhhbmRsZXI8UywgUD4sIG5hbWU6IHN0cmluZyk6IChwYXlsb2FkOiBQKSA9PiB2b2lkO1xuICBjb21taXQ8UD4oaGFuZGxlcjogTXV0YXRpb25IYW5kbGVyPFMsIFA+LCBuYW1lPzogc3RyaW5nKSB7XG4gICAgY29uc3QgeyBrZXksIG5hbWVzcGFjZWRLZXkgfSA9IHF1YWxpZnlLZXkoaGFuZGxlciwgdGhpcy5uYW1lc3BhY2UsIG5hbWUpO1xuICAgIGlmICh0aGlzLl9tdXRhdGlvbnNba2V5XSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBUaGVyZSBpcyBhbHJlYWR5IGEgbXV0YXRpb24gbmFtZWQgJHtrZXl9LmApO1xuICAgIH1cbiAgICB0aGlzLl9tdXRhdGlvbnNba2V5XSA9IGhhbmRsZXI7XG4gICAgcmV0dXJuICgocGF5bG9hZDogUCkgPT5cbiAgICAgIHRoaXMuX3N0b3JlIS5jb21taXQobmFtZXNwYWNlZEtleSwgcGF5bG9hZCwgdXNlUm9vdE5hbWVzcGFjZSkpIGFzIGFueTtcbiAgfVxuXG4gIGRpc3BhdGNoPFAsIFQ+KGhhbmRsZXI6IEFjdGlvbkhhbmRsZXI8UywgUiwgdm9pZCwgdm9pZD4pOiAoKSA9PiBQcm9taXNlPHZvaWQ+O1xuICBkaXNwYXRjaDxQLCBUPihcbiAgICBoYW5kbGVyOiBBY3Rpb25IYW5kbGVyPFMsIFIsIFAsIHZvaWQ+XG4gICk6IChwYXlsb2FkOiBQKSA9PiBQcm9taXNlPHZvaWQ+O1xuICBkaXNwYXRjaDxQLCBUPihoYW5kbGVyOiBBY3Rpb25IYW5kbGVyPFMsIFIsIHZvaWQsIFQ+KTogKCkgPT4gUHJvbWlzZTxUPjtcbiAgZGlzcGF0Y2g8UCwgVD4oXG4gICAgaGFuZGxlcjogQWN0aW9uSGFuZGxlcjxTLCBSLCBQLCBUPlxuICApOiAocGF5bG9hZDogUCkgPT4gUHJvbWlzZTxUPjtcbiAgZGlzcGF0Y2g8UCwgVD4oXG4gICAgaGFuZGxlcjogQWN0aW9uSGFuZGxlcjxTLCBSLCB2b2lkLCB2b2lkPixcbiAgICBuYW1lOiBzdHJpbmdcbiAgKTogKCkgPT4gUHJvbWlzZTx2b2lkPjtcbiAgZGlzcGF0Y2g8UCwgVD4oXG4gICAgaGFuZGxlcjogQWN0aW9uSGFuZGxlcjxTLCBSLCBQLCB2b2lkPixcbiAgICBuYW1lOiBzdHJpbmdcbiAgKTogKHBheWxvYWQ6IFApID0+IFByb21pc2U8dm9pZD47XG4gIGRpc3BhdGNoPFAsIFQ+KFxuICAgIGhhbmRsZXI6IEFjdGlvbkhhbmRsZXI8UywgUiwgdm9pZCwgVD4sXG4gICAgbmFtZTogc3RyaW5nXG4gICk6ICgpID0+IFByb21pc2U8VD47XG4gIGRpc3BhdGNoPFAsIFQ+KFxuICAgIGhhbmRsZXI6IEFjdGlvbkhhbmRsZXI8UywgUiwgUCwgVD4sXG4gICAgbmFtZTogc3RyaW5nXG4gICk6IChwYXlsb2FkOiBQKSA9PiBQcm9taXNlPFQ+O1xuICBkaXNwYXRjaDxQLCBUPihoYW5kbGVyOiBhbnksIG5hbWU/OiBzdHJpbmcpOiBhbnkge1xuICAgIGNvbnN0IHsga2V5LCBuYW1lc3BhY2VkS2V5IH0gPSBxdWFsaWZ5S2V5KGhhbmRsZXIsIHRoaXMubmFtZXNwYWNlLCBuYW1lKTtcbiAgICBpZiAodGhpcy5fYWN0aW9uc1trZXldKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZXJlIGlzIGFscmVhZHkgYW4gYWN0aW9uIG5hbWVkICR7a2V5fS5gKTtcbiAgICB9XG4gICAgdGhpcy5fYWN0aW9uc1trZXldID0gaGFuZGxlcjtcbiAgICByZXR1cm4gKHBheWxvYWQ6IFApID0+XG4gICAgICB0aGlzLl9zdG9yZSEuZGlzcGF0Y2gobmFtZXNwYWNlZEtleSwgcGF5bG9hZCwgdXNlUm9vdE5hbWVzcGFjZSk7XG4gIH1cblxuICByZWFkPFQ+KGhhbmRsZXI6IEdldHRlckhhbmRsZXI8UywgUiwgVD4pOiAoKSA9PiBUO1xuICByZWFkPFQ+KGhhbmRsZXI6IEdldHRlckhhbmRsZXI8UywgUiwgVD4sIG5hbWU6IHN0cmluZyk6ICgpID0+IFQ7XG4gIHJlYWQ8VD4oaGFuZGxlcjogR2V0dGVySGFuZGxlcjxTLCBSLCBUPiwgbmFtZT86IHN0cmluZyk6ICgpID0+IFQge1xuICAgIGNvbnN0IHsga2V5LCBuYW1lc3BhY2VkS2V5IH0gPSBxdWFsaWZ5S2V5KGhhbmRsZXIsIHRoaXMubmFtZXNwYWNlLCBuYW1lKTtcbiAgICBpZiAodGhpcy5fZ2V0dGVyc1trZXldKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZXJlIGlzIGFscmVhZHkgYSBnZXR0ZXIgbmFtZWQgJHtrZXl9LmApO1xuICAgIH1cbiAgICB0aGlzLl9nZXR0ZXJzW2tleV0gPSBoYW5kbGVyO1xuICAgIHJldHVybiAoKSA9PiB7XG4gICAgICBpZiAodGhpcy5fc3RvcmUhLnJvb3RHZXR0ZXJzKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9zdG9yZSEucm9vdEdldHRlcnNbbmFtZXNwYWNlZEtleV0gYXMgVDtcbiAgICAgIH1cbiAgICAgIHJldHVybiB0aGlzLl9zdG9yZSEuZ2V0dGVyc1tuYW1lc3BhY2VkS2V5XSBhcyBUO1xuICAgIH07XG4gIH1cblxuICB2dWV4TW9kdWxlKCk6IE1vZHVsZTxTLCBSPiB7XG4gICAgaWYgKCF0aGlzLl92dWV4TW9kdWxlKSB7XG4gICAgICAvLyBidWlsZCBuZXN0ZWQgbW9kdWxlcyByZWN1cnNpdmVseSwgaWYgYW55XG4gICAgICBjb25zdCBtb2R1bGVzOiBNb2R1bGVUcmVlPFI+ID0ge307XG4gICAgICBmb3IgKGNvbnN0IG5hbWVzcGFjZSBvZiBPYmplY3Qua2V5cyh0aGlzLl9tb2R1bGVCdWlsZGVycykpIHtcbiAgICAgICAgbW9kdWxlc1tuYW1lc3BhY2VdID0gdGhpcy5fbW9kdWxlQnVpbGRlcnNbbmFtZXNwYWNlXS52dWV4TW9kdWxlKCk7XG4gICAgICB9XG5cbiAgICAgIHRoaXMuX3Z1ZXhNb2R1bGUgPSB7XG4gICAgICAgIG5hbWVzcGFjZWQ6IHRydWUsXG4gICAgICAgIHN0YXRlOiB0aGlzLl9pbml0aWFsU3RhdGUsXG4gICAgICAgIGdldHRlcnM6IHRoaXMuX2dldHRlcnMsXG4gICAgICAgIG11dGF0aW9uczogdGhpcy5fbXV0YXRpb25zLFxuICAgICAgICBhY3Rpb25zOiB0aGlzLl9hY3Rpb25zLFxuICAgICAgICBtb2R1bGVzXG4gICAgICB9O1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5fdnVleE1vZHVsZTtcbiAgfVxuXG4gIF9wcm92aWRlU3RvcmUoc3RvcmU6IFN0b3JlPFI+KSB7XG4gICAgdGhpcy5fc3RvcmUgPSBzdG9yZTtcblxuICAgIGZvckVhY2hWYWx1ZSh0aGlzLl9tb2R1bGVCdWlsZGVycywgbSA9PiBtLl9wcm92aWRlU3RvcmUoc3RvcmUpKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBxdWFsaWZ5S2V5KFxuICBoYW5kbGVyOiBGdW5jdGlvbixcbiAgbmFtZXNwYWNlOiBzdHJpbmcgfCB1bmRlZmluZWQsXG4gIG5hbWU/OiBzdHJpbmdcbik6IHsga2V5OiBzdHJpbmc7IG5hbWVzcGFjZWRLZXk6IHN0cmluZyB9IHtcbiAgY29uc3Qga2V5OiBzdHJpbmcgPSBuYW1lIHx8IGhhbmRsZXIubmFtZTtcbiAgaWYgKCFrZXkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICBgVnVleCBoYW5kbGVyIGZ1bmN0aW9ucyBtdXN0IG5vdCBiZSBhbm9ueW1vdXMuIFBvc3NpYmxlIGNhdXNlczogZmF0LWFycm93IGZ1bmN0aW9ucywgdWdsaWZ5LiAgVG8gZml4LCBwYXNzIGEgdW5pcXVlIG5hbWUgYXMgYSBzZWNvbmQgcGFyYW1ldGVyIGFmdGVyIHlvdXIgY2FsbGJhY2suYFxuICAgICk7XG4gIH1cbiAgcmV0dXJuIHsga2V5LCBuYW1lc3BhY2VkS2V5OiBxdWFsaWZ5TmFtZXNwYWNlKG5hbWVzcGFjZSwga2V5KSB9O1xufVxuXG5mdW5jdGlvbiBxdWFsaWZ5TmFtZXNwYWNlKG5hbWVzcGFjZTogc3RyaW5nIHwgdW5kZWZpbmVkLCBrZXk6IHN0cmluZykge1xuICByZXR1cm4gbmFtZXNwYWNlID8gYCR7bmFtZXNwYWNlfS8ke2tleX1gIDoga2V5O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIE1vZHVsZUJ1aWxkZXI8UywgUiA9IHt9PiB7XG4gIC8qKiBUaGUgbmFtZXNwYWNlIG9mIHRoaXMgTW9kdWxlQnVpbGRlciAqL1xuICByZWFkb25seSBuYW1lc3BhY2U6IHN0cmluZztcblxuICAvKiogQ3JlYXRlcyBhIHN0cm9uZ2x5LXR5cGVkIG5lc3RlZCBtb2R1bGUgd2l0aGluIHRoaXMgbW9kdWxlICovXG4gIG1vZHVsZTxNPihuYW1lc3BhY2U6IHN0cmluZywgaW5pdGlhbFN0YXRlOiBNKTogTW9kdWxlQnVpbGRlcjxNLCBSPjtcblxuICAvKiogR2V0cyBhbiBleGlzdGluZyBuZXN0ZWQgbW9kdWxlIHdpdGhpbiB0aGlzIG1vZHVsZSAqL1xuICBtb2R1bGU8TT4obmFtZXNwYWNlOiBzdHJpbmcpOiBNb2R1bGVCdWlsZGVyPE0sIFI+O1xuXG4gIC8qKiBDcmVhdGVzIGEgc3Ryb25nbHktdHlwZWQgY29tbWl0IGZ1bmN0aW9uIGZvciB0aGUgcHJvdmlkZWQgbXV0YXRpb24gaGFuZGxlciAqL1xuICBjb21taXQ8UD4oaGFuZGxlcjogTXV0YXRpb25IYW5kbGVyPFMsIHZvaWQ+KTogKCkgPT4gdm9pZDtcbiAgY29tbWl0PFA+KGhhbmRsZXI6IE11dGF0aW9uSGFuZGxlcjxTLCBQPik6IChwYXlsb2FkOiBQKSA9PiB2b2lkO1xuICBjb21taXQ8UD4oaGFuZGxlcjogTXV0YXRpb25IYW5kbGVyPFMsIHZvaWQ+LCBuYW1lOiBzdHJpbmcpOiAoKSA9PiB2b2lkO1xuICBjb21taXQ8UD4oaGFuZGxlcjogTXV0YXRpb25IYW5kbGVyPFMsIFA+LCBuYW1lOiBzdHJpbmcpOiAocGF5bG9hZDogUCkgPT4gdm9pZDtcblxuICAvKiogQ3JlYXRlcyBhIHN0cm9uZ2x5LXR5cGVkIGRpc3BhdGNoIGZ1bmN0aW9uIGZvciB0aGUgcHJvdmlkZWQgYWN0aW9uIGhhbmRsZXIgKi9cbiAgZGlzcGF0Y2g8UCwgVD4oaGFuZGxlcjogQWN0aW9uSGFuZGxlcjxTLCBSLCB2b2lkLCB2b2lkPik6ICgpID0+IFByb21pc2U8dm9pZD47XG4gIGRpc3BhdGNoPFAsIFQ+KFxuICAgIGhhbmRsZXI6IEFjdGlvbkhhbmRsZXI8UywgUiwgUCwgdm9pZD5cbiAgKTogKHBheWxvYWQ6IFApID0+IFByb21pc2U8dm9pZD47XG4gIGRpc3BhdGNoPFAsIFQ+KGhhbmRsZXI6IEFjdGlvbkhhbmRsZXI8UywgUiwgdm9pZCwgVD4pOiAoKSA9PiBQcm9taXNlPFQ+O1xuICBkaXNwYXRjaDxQLCBUPihcbiAgICBoYW5kbGVyOiBBY3Rpb25IYW5kbGVyPFMsIFIsIFAsIFQ+XG4gICk6IChwYXlsb2FkOiBQKSA9PiBQcm9taXNlPFQ+O1xuICBkaXNwYXRjaDxQLCBUPihcbiAgICBoYW5kbGVyOiBBY3Rpb25IYW5kbGVyPFMsIFIsIHZvaWQsIHZvaWQ+LFxuICAgIG5hbWU6IHN0cmluZ1xuICApOiAoKSA9PiBQcm9taXNlPHZvaWQ+O1xuICBkaXNwYXRjaDxQLCBUPihcbiAgICBoYW5kbGVyOiBBY3Rpb25IYW5kbGVyPFMsIFIsIFAsIHZvaWQ+LFxuICAgIG5hbWU6IHN0cmluZ1xuICApOiAocGF5bG9hZDogUCkgPT4gUHJvbWlzZTx2b2lkPjtcbiAgZGlzcGF0Y2g8UCwgVD4oXG4gICAgaGFuZGxlcjogQWN0aW9uSGFuZGxlcjxTLCBSLCB2b2lkLCBUPixcbiAgICBuYW1lOiBzdHJpbmdcbiAgKTogKCkgPT4gUHJvbWlzZTxUPjtcbiAgZGlzcGF0Y2g8UCwgVD4oXG4gICAgaGFuZGxlcjogQWN0aW9uSGFuZGxlcjxTLCBSLCBQLCBUPixcbiAgICBuYW1lOiBzdHJpbmdcbiAgKTogKHBheWxvYWQ6IFApID0+IFByb21pc2U8VD47XG5cbiAgLyoqIENyZWF0ZXMgYSBzdHJvbmdseS10eXBlZCByZWFkIGZ1bmN0aW9uIGZvciB0aGUgcHJvdmlkZWQgZ2V0dGVyIGZ1bmN0aW9uICovXG4gIHJlYWQ8VD4oaGFuZGxlcjogR2V0dGVySGFuZGxlcjxTLCBSLCBUPik6ICgpID0+IFQ7XG4gIHJlYWQ8VD4oaGFuZGxlcjogR2V0dGVySGFuZGxlcjxTLCBSLCBUPiwgbmFtZTogc3RyaW5nKTogKCkgPT4gVDtcblxuICAvKiogQ3JlYXRlcyBhIG1ldGhvZCB0byByZXR1cm4gdGhpcyBtb2R1bGUncyBzdGF0ZSAqL1xuICBzdGF0ZSgpOiAoKSA9PiBTO1xuXG4gIC8qKiBPdXRwdXQgYSBWdWV4IE1vZHVsZSBkZWZpbml0aW9uLiBDYWxsZWQgYWZ0ZXIgYWxsIHN0cm9uZ2x5LXR5cGVkIGZ1bmN0aW9ucyBoYXZlIGJlZW4gb2J0YWluZWQgKi9cbiAgdnVleE1vZHVsZSgpOiBNb2R1bGU8UywgUj47XG5cbiAgX3Byb3ZpZGVTdG9yZShzdG9yZTogU3RvcmU8Uj4pOiB2b2lkO1xufVxuXG5jbGFzcyBTdG9yZUJ1aWxkZXJJbXBsPFI+IGV4dGVuZHMgTW9kdWxlQnVpbGRlckltcGw8YW55LCBSPiB7XG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHN1cGVyKCcnLCB7fSk7XG4gIH1cblxuICBtb2R1bGU8Uz4obmFtZXNwYWNlOiBzdHJpbmcsIGluaXRpYWxTdGF0ZTogUyk6IE1vZHVsZUJ1aWxkZXI8UywgUj47XG4gIG1vZHVsZTxTPihuYW1lc3BhY2U6IHN0cmluZyk6IE1vZHVsZUJ1aWxkZXI8UywgUj47XG4gIG1vZHVsZTxTPihuYW1lc3BhY2U6IHN0cmluZywgaW5pdGlhbFN0YXRlPzogUyk6IE1vZHVsZUJ1aWxkZXI8UywgUj4ge1xuICAgIGlmICh0aGlzLl9zdG9yZSAmJiBpbml0aWFsU3RhdGUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkNhbid0IGFkZCBtb2R1bGUgYWZ0ZXIgdnVleFN0b3JlKCkgaGFzIGJlZW4gY2FsbGVkXCIpO1xuICAgIH1cblxuICAgIHJldHVybiBzdXBlci5tb2R1bGUobmFtZXNwYWNlLCBpbml0aWFsU3RhdGUpIGFzIE1vZHVsZUJ1aWxkZXI8UywgUj47XG4gIH1cblxuICB2dWV4U3RvcmUoKTogU3RvcmU8Uj47XG4gIHZ1ZXhTdG9yZShvdmVycmlkZU9wdGlvbnM6IFN0b3JlT3B0aW9uczxSPik6IFN0b3JlPFI+O1xuICB2dWV4U3RvcmUob3ZlcnJpZGVPcHRpb25zOiBTdG9yZU9wdGlvbnM8Uj4gPSB7fSk6IFN0b3JlPFI+IHtcbiAgICBpZiAoIXRoaXMuX3N0b3JlKSB7XG4gICAgICBjb25zdCBvcHRpb25zOiBTdG9yZU9wdGlvbnM8Uj4gJiB7IG5hbWVzcGFjZWQ/OiBib29sZWFuIH0gPSB7XG4gICAgICAgIC4uLnRoaXMudnVleE1vZHVsZSgpLFxuICAgICAgICAuLi5vdmVycmlkZU9wdGlvbnNcbiAgICAgIH07XG4gICAgICBjb25zdCBzdG9yZSA9IG5ldyBTdG9yZTxSPihvcHRpb25zKTtcbiAgICAgIGZvckVhY2hWYWx1ZSh0aGlzLl9tb2R1bGVCdWlsZGVycywgbSA9PiBtLl9wcm92aWRlU3RvcmUoc3RvcmUpKTtcbiAgICAgIHRoaXMuX3N0b3JlID0gc3RvcmU7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLl9zdG9yZTtcbiAgfVxuXG4gIHJlc2V0KCkge1xuICAgIHRoaXMuX3N0b3JlID0gdW5kZWZpbmVkO1xuICAgIHRoaXMuX21vZHVsZUJ1aWxkZXJzID0ge307XG4gIH1cbn1cblxuY29uc3QgZm9yRWFjaFZhbHVlID0gPFQ+KGRpY3Q6IERpY3Rpb25hcnk8VD4sIGxvb3A6ICh2YWx1ZTogVCkgPT4gYW55KSA9PiB7XG4gIE9iamVjdC5rZXlzKGRpY3QpLmZvckVhY2goa2V5ID0+IGxvb3AoZGljdFtrZXldKSk7XG59O1xuXG5leHBvcnQgaW50ZXJmYWNlIFZ1ZXhTdG9yZU9wdGlvbnM8Uj4ge1xuICBwbHVnaW5zPzogUGx1Z2luPFI+W107XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgU3RvcmVCdWlsZGVyPFI+IHtcbiAgLyoqIENyZWF0ZXMgYSBNb2R1bGVCdWlsZGVyIGZvciB0aGUgbmFtZXNwYWNlIHByb3ZpZGVkICovXG4gIG1vZHVsZTxTPihuYW1lc3BhY2U6IHN0cmluZywgc3RhdGU6IFMpOiBNb2R1bGVCdWlsZGVyPFMsIFI+O1xuXG4gIC8qKiBHZXRzIGFuIGV4aXN0aW5nIE1vZHVsZUJ1aWxkZXIgZm9yIHRoZSBuYW1lc3BhY2UgcHJvdmlkZWQgKi9cbiAgbW9kdWxlPFM+KG5hbWVzcGFjZTogc3RyaW5nKTogTW9kdWxlQnVpbGRlcjxTLCBSPjtcblxuICAvKiogT3V0cHV0IGEgVnVleCBTdG9yZSBhZnRlciBhbGwgbW9kdWxlcyBoYXZlIGJlZW4gYnVpbHQgKi9cbiAgdnVleFN0b3JlKCk6IFN0b3JlPFI+O1xuXG4gIC8qKiBPdXRwdXQgYSBWdWV4IFN0b3JlIGFuZCBwcm92aWRlIG9wdGlvbnMsIGUuZy4gcGx1Z2lucyAtLSB0aGVzZSB0YWtlIHByZWNlZGVuY2Ugb3ZlciBhbnkgYXV0by1nZW5lcmF0ZWQgb3B0aW9ucyAqL1xuICB2dWV4U3RvcmUob3ZlcnJpZGVPcHRpb25zOiBTdG9yZU9wdGlvbnM8Uj4pOiBTdG9yZTxSPjtcblxuICAvKiogQ3JlYXRlcyBhIHN0cm9uZ2x5LXR5cGVkIGNvbW1pdCBmdW5jdGlvbiBmb3IgdGhlIHByb3ZpZGVkIG11dGF0aW9uIGhhbmRsZXIgKi9cbiAgY29tbWl0PFA+KGhhbmRsZXI6IE11dGF0aW9uSGFuZGxlcjxSLCB2b2lkPik6ICgpID0+IHZvaWQ7XG4gIGNvbW1pdDxQPihoYW5kbGVyOiBNdXRhdGlvbkhhbmRsZXI8UiwgUD4pOiAocGF5bG9hZDogUCkgPT4gdm9pZDtcbiAgY29tbWl0PFA+KGhhbmRsZXI6IE11dGF0aW9uSGFuZGxlcjxSLCB2b2lkPiwgbmFtZTogc3RyaW5nKTogKCkgPT4gdm9pZDtcbiAgY29tbWl0PFA+KGhhbmRsZXI6IE11dGF0aW9uSGFuZGxlcjxSLCBQPiwgbmFtZTogc3RyaW5nKTogKHBheWxvYWQ6IFApID0+IHZvaWQ7XG5cbiAgLyoqIENyZWF0ZXMgYSBzdHJvbmdseS10eXBlZCBkaXNwYXRjaCBmdW5jdGlvbiBmb3IgdGhlIHByb3ZpZGVkIGFjdGlvbiBoYW5kbGVyICovXG4gIGRpc3BhdGNoPFAsIFQ+KGhhbmRsZXI6IEFjdGlvbkhhbmRsZXI8UiwgUiwgdm9pZCwgdm9pZD4pOiAoKSA9PiBQcm9taXNlPHZvaWQ+O1xuICBkaXNwYXRjaDxQLCBUPihcbiAgICBoYW5kbGVyOiBBY3Rpb25IYW5kbGVyPFIsIFIsIFAsIHZvaWQ+XG4gICk6IChwYXlsb2FkOiBQKSA9PiBQcm9taXNlPHZvaWQ+O1xuICBkaXNwYXRjaDxQLCBUPihoYW5kbGVyOiBBY3Rpb25IYW5kbGVyPFIsIFIsIHZvaWQsIFQ+KTogKCkgPT4gUHJvbWlzZTxUPjtcbiAgZGlzcGF0Y2g8UCwgVD4oXG4gICAgaGFuZGxlcjogQWN0aW9uSGFuZGxlcjxSLCBSLCBQLCBUPlxuICApOiAocGF5bG9hZDogUCkgPT4gUHJvbWlzZTxUPjtcbiAgZGlzcGF0Y2g8UCwgVD4oXG4gICAgaGFuZGxlcjogQWN0aW9uSGFuZGxlcjxSLCBSLCB2b2lkLCB2b2lkPixcbiAgICBuYW1lOiBzdHJpbmdcbiAgKTogKCkgPT4gUHJvbWlzZTx2b2lkPjtcbiAgZGlzcGF0Y2g8UCwgVD4oXG4gICAgaGFuZGxlcjogQWN0aW9uSGFuZGxlcjxSLCBSLCBQLCB2b2lkPixcbiAgICBuYW1lOiBzdHJpbmdcbiAgKTogKHBheWxvYWQ6IFApID0+IFByb21pc2U8dm9pZD47XG4gIGRpc3BhdGNoPFAsIFQ+KFxuICAgIGhhbmRsZXI6IEFjdGlvbkhhbmRsZXI8UiwgUiwgdm9pZCwgVD4sXG4gICAgbmFtZTogc3RyaW5nXG4gICk6ICgpID0+IFByb21pc2U8VD47XG4gIGRpc3BhdGNoPFAsIFQ+KFxuICAgIGhhbmRsZXI6IEFjdGlvbkhhbmRsZXI8UiwgUiwgUCwgVD4sXG4gICAgbmFtZTogc3RyaW5nXG4gICk6IChwYXlsb2FkOiBQKSA9PiBQcm9taXNlPFQ+O1xuXG4gIC8qKiBDcmVhdGVzIGEgc3Ryb25nbHktdHlwZWQgcmVhZCBmdW5jdGlvbiBmb3IgdGhlIHByb3ZpZGVkIGdldHRlciBmdW5jdGlvbiAqL1xuICByZWFkPFQ+KGhhbmRsZXI6IEdldHRlckhhbmRsZXI8UiwgUiwgVD4pOiAoKSA9PiBUO1xuICByZWFkPFQ+KGhhbmRsZXI6IEdldHRlckhhbmRsZXI8UiwgUiwgVD4sIG5hbWU6IHN0cmluZyk6ICgpID0+IFQ7XG5cbiAgLyoqIENyZWF0ZXMgYSBtZXRob2QgdG8gcmV0dXJuIHRoZSByb290IHN0YXRlICovXG4gIHN0YXRlKCk6ICgpID0+IFI7XG5cbiAgLyoqIFdBUk5JTkc6IERpc2NhcmRzIHZ1ZXggc3RvcmUgYW5kIHJlc2V0IG1vZHVsZXMgKG5vbiBpbnRlbmRlZCBmb3IgZW5kLXVzZXIgdXNlKSAqL1xuICByZXNldCgpOiB2b2lkO1xufVxuXG5jb25zdCBzdG9yZUJ1aWxkZXJTaW5nbGV0b24gPSBuZXcgU3RvcmVCdWlsZGVySW1wbDxhbnk+KCk7XG5jb25zdCBuYW1lZFN0b3JlQnVpbGRlck1hcDoge1xuICBbbmFtZTogc3RyaW5nXTogU3RvcmVCdWlsZGVySW1wbDxhbnk+O1xufSA9IE9iamVjdC5jcmVhdGUobnVsbCk7XG5cbi8qKiBHZXQgYSByZWZlcmVuY2UgdG8gdGhlIGRlZmF1bHQgc3RvcmUgYnVpbGRlciAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdldFN0b3JlQnVpbGRlcjxSPigpOiBTdG9yZUJ1aWxkZXI8Uj47XG4vKiogR2V0IGEgcmVmZXJlbmNlIHRvIGEgbmFtZWQgc3RvcmUgYnVpbGRlciAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdldFN0b3JlQnVpbGRlcjxSPihuYW1lOiBzdHJpbmcpOiBTdG9yZUJ1aWxkZXI8Uj47XG5leHBvcnQgZnVuY3Rpb24gZ2V0U3RvcmVCdWlsZGVyPFI+KG5hbWU/OiBzdHJpbmcpOiBTdG9yZUJ1aWxkZXI8Uj4ge1xuICAvLyB0aGUgZGVmYXVsdCBzdG9yZSBidWlsZGVyXG4gIGlmICghbmFtZSkge1xuICAgIHJldHVybiBzdG9yZUJ1aWxkZXJTaW5nbGV0b247XG4gIH1cblxuICAvLyBhIG5hbWVkIHN0b3JlIGJ1aWxkZXJcbiAgY29uc3QgYnVpbGRlciA9XG4gICAgbmFtZWRTdG9yZUJ1aWxkZXJNYXBbbmFtZV0gfHxcbiAgICAobmFtZWRTdG9yZUJ1aWxkZXJNYXBbbmFtZV0gPSBuZXcgU3RvcmVCdWlsZGVySW1wbDxSPigpKTtcbiAgcmV0dXJuIGJ1aWxkZXI7XG59XG4iXX0=